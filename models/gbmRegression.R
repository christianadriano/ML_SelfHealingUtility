#Train GBM General Boosting Model
#Ten-fold cross-validation
#Trains model with different dataset sizes 1k 3K 9K
#
#Validate model with holdout dataset
#
#Convert model to pmml
##https://github.com/jpmml/r2pmml

#Automatic model selection

# Train function  ---------------------------------------------------------
trainGBM <- function(features.df,numberOfTrees=2500,kfolds=10){
 
  #lightGBM with caret?
  #https://github.com/bwilbertz/RLightGBM
   
  features.df <- dim(features.df)[2] - 1; #last column is the target variable
  
  #train.data = gbm.DMatrix(data.matrix(trainingData[,1:features.df]), 
  #                            label = trainingData[,"UTILITY_INCREASE"],
  #                           missing = NA)
  
  
  #system.time gets the time to train the model
  system.time(
    trained.model <- gbm(UTILIT_INCREASE~.,
                  data = trainingData[,1:features.df],
                  distribution = gaussian,
                  n.trees = numberOfTrees,
                  n.minobsinnode = 100,
                  shrinkage = 0.01,
                  bag.fraction = 0.5,
                  cv.folds = kfolds)
    )
  
  best.iteration = gbm.perf(trained.model, method = "cv")
  
  #trained.model$evaluation_log[best_iteration]
  
  best.model <- gbm(param =param,  data = xgb.train.data, nrounds=best_iteration)
  
  # Get feature importance
  gbm.feature.imp = summary(trained.model, n.trees = best.iter)
  
  return(list(best.model,trained.model));
}

# Validation -------------------------------------------------------------
validateGBMPredictions <- function(modelList,validationData,i){
  
  results.df <- data.frame(matrix(data=NA,nrow=3,ncol=12));
  colnames(results.df) <- c("Item","Utility_Type","Train_RMSE_MEAN","Train_RMSE_STD","Test_RMSE_MEAN",
                            "Test_RMSE_STD","RMSE","R_Squared", "MAPD","User_Time","Sys_Time","Elapsed_Time");
  
  best.model <- modelList[[1]];
  trained.model <- modelList[[2]];
  time.df <- modelList[[3]]
  
  best_iteration <- trained.model$best_iteration;
  
  y_pred <- predict(best.model, as.matrix(validationData));
  error <- y_pred - validationData$UTILITY_INCREASE;
  
  best_iteration <- trained.model$best_iteration;
  results.df$Item[i] <- i;
  results.df$Utility_Type[i]<-gsub(" ","",datasetName[i],fixed = TRUE);
  results.df$Train_RMSE_MEAN[i]<-trained.model$evaluation_log[best_iteration]$train_rmse_mean;
  results.df$Train_RMSE_STD[i]<-trained.model$evaluation_log[best_iteration]$train_rmse_std;
  results.df$Test_RMSE_MEAN[i]<-trained.model$evaluation_log[best_iteration]$test_rmse_mean;
  results.df$Test_RMSE_STD[i]<-trained.model$evaluation_log[best_iteration]$test_rmse_std;
  
  results.df$RMSE[i] <- rmse(error);
  results.df$R_Squared[i] <- r_squared(y_pred,validationData$UTILITY_INCREASE);
  results.df$MAPD[i] <- mapd(y_pred,validationData$UTILITY_INCREASE);
  
  results.df$User_Time[i] <- time.df$user.time;
  results.df$Sys_Time[i] <- time.df$sys.time;
  results.df$Elapsed_Time[i] <- time.df$elapsed.time;
  
  return(results.df); 
}

